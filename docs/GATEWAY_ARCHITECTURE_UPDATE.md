# üìä API GATEWAY - –û–ë–ù–û–í–õ–ï–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–´

## üéØ **–¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° (2025-08-19 17:20):**

### ‚úÖ **API GATEWAY –£–°–ü–ï–®–ù–û –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù –í PRODUCTION!**

---

## üèóÔ∏è **ARCHITECTURE UPDATE:**

### **–î–û –ò–ù–¢–ï–ì–†–ê–¶–ò–ò GATEWAY:**
```
test-admin.beauty.designcorp.eu
    ‚Üì nginx
    ‚Üì /api/auth/ ‚Üí Auth Service (6021)
    ‚Üì / ‚Üí Admin Panel (6002)
```

### **–ü–û–°–õ–ï –ò–ù–¢–ï–ì–†–ê–¶–ò–ò GATEWAY:**
```
test-admin.beauty.designcorp.eu  
    ‚Üì nginx
    ‚Üì /api/auth/ ‚Üí API Gateway (6020) ‚Üí Auth Service (6021) ‚úÖ
    ‚Üì / ‚Üí Admin Panel (6002) ‚úÖ
```

---

## üìã **–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –°–¢–ê–¢–£–°:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ß–µ—Ä–µ–∑ Gateway? | URL |
|-----------|--------|----------------|-----|
| **Admin Panel UI** | ‚úÖ Production | ‚ùå –ü—Ä—è–º–æ | test-admin.beauty.designcorp.eu |
| **Auth API** | ‚úÖ Production | **‚úÖ Gateway** | /api/auth/* |
| **Images API** | ‚úÖ Ready | ‚ùå –ü—Ä—è–º–æ | /api/images/* |
| **MCP API** | ‚úÖ Ready | ‚ùå –ü—Ä—è–º–æ | /api/mcp/* |
| **Salon CRM** | ‚úÖ Production | ‚ùå –ü—Ä—è–º–æ | test-crm.beauty.designcorp.eu |
| **Client Portal** | ‚úÖ Production | ‚ùå –ü—Ä—è–º–æ | client.beauty.designcorp.eu |

---

## üîß **GATEWAY –ù–ê–°–¢–†–û–ô–ö–ò:**

### **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (Production):**
- ‚úÖ `POST /api/auth/login` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ `GET /api/auth/me` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- ‚úÖ `GET /api/auth/csrf-token` - CSRF —Ç–æ–∫–µ–Ω—ã
- ‚úÖ `POST /api/auth/refresh` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ `POST /api/auth/logout` - –≤—ã—Ö–æ–¥

### **–ì–æ—Ç–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å (–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ):**
- üìã `GET /api/images/*` - Images API
- üìã `GET /api/mcp/*` - MCP Server  
- üìã `POST /api/booking/*` - Booking Service
- üìã `POST /api/notifications/*` - Notification Service
- üìã `POST /api/payments/*` - Payment Service

---

## üß™ **–†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø:**

### **‚úÖ –£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã:**
```bash
# –ê–¥–º–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è:
curl https://test-admin.beauty.designcorp.eu ‚Üí 200 ‚úÖ

# CSRF —á–µ—Ä–µ–∑ Gateway:
curl https://test-admin.beauty.designcorp.eu/api/auth/csrf-token
# Response: {"success":true,"csrfToken":"..."} ‚úÖ

# –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Gateway:  
curl -X POST https://test-admin.beauty.designcorp.eu/api/auth/login
# Response: {"success":true,"user":{...}} ‚úÖ

# –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:
curl https://test-admin.beauty.designcorp.eu/api/auth/me
# Response: {"success":true,"user":{...}} ‚úÖ
```

### **üç™ Cookies —Ä–∞–±–æ—Ç–∞—é—Ç:**
- ‚úÖ `beauty_access_token` (JWT)
- ‚úÖ `beauty_refresh_token` (Refresh)  
- ‚úÖ `_csrf` (CSRF protection)

---

## üìà **–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê GATEWAY:**

### **1. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
‚úÖ Proxied POST /api/auth/login to Auth Service
   Status: 200, Headers: 25, Content-Type: application/json
üéâ Response completed for POST /api/auth/login
```

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
- –í—Å–µ Auth API –∑–∞–ø—Ä–æ—Å—ã –≤–∏–¥–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ cookies, CSRF, —Å—Ç–∞—Ç—É—Å–∞—Ö
- –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ httpOnly cookies
- CSRF —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è  
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤

### **4. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –ì–æ—Ç–æ–≤ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
- –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –≤—Å–µ—Ö API
- –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ nginx

---

## üöÄ **–ü–õ–ê–ù –†–ê–ó–í–ò–¢–ò–Ø:**

### **–§–∞–∑–∞ 1: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê**
```
Auth API ‚Üí Gateway ‚Üí Production ‚úÖ
```

### **–§–∞–∑–∞ 2: üìã –ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø**
```nginx
# –î–æ–±–∞–≤–∏—Ç—å Images API:
location /api/images/ {
    proxy_pass http://127.0.0.1:6020/api/images/;
}

# –î–æ–±–∞–≤–∏—Ç—å MCP API:
location /api/mcp/ {
    proxy_pass http://127.0.0.1:6020/api/mcp/;
}
```

### **–§–∞–∑–∞ 3: üìã –ë–£–î–£–©–ï–ï**
```
–í—Å–µ API ‚Üí Gateway ‚Üí –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```

---

## üîí **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ GATEWAY:**

### **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ cookies (cookieDomainRewrite: false)
- ‚úÖ CSRF —Ç–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (criticalHeaders)
- ‚úÖ HTTPS ready
- ‚úÖ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
- ‚úÖ Request ID –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞

### **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚úÖ POST timeout (body parsing –∫–æ–Ω—Ñ–ª–∏–∫—Ç)  
- ‚úÖ Cookies —Ç–µ—Ä—è–ª–∏—Å—å (–Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –∑–∞–≥–æ–ª–æ–≤–∫–∏)
- ‚úÖ CSRF –ª–æ–º–∞–ª—Å—è (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ csrf.ts)

---

## üõ†Ô∏è **–£–ü–†–ê–í–õ–ï–ù–ò–ï:**

### **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Gateway:**
```bash
# –°—Ç–∞—Ç—É—Å:
pm2 list | grep gateway

# –õ–æ–≥–∏:
pm2 logs beauty-api-gateway --lines 20

# –ú–µ—Ç—Ä–∏–∫–∏:
curl http://localhost:6020/metrics
```

### **–û—Ç–∫–∞—Ç –∫ –ø—Ä—è–º–æ–º—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é:**
```bash
# –ò–∑–º–µ–Ω–∏—Ç—å nginx:
location /api/auth/ {
    proxy_pass http://127.0.0.1:6021/auth/;  # –ü—Ä—è–º–æ –∫ Auth
}
sudo systemctl reload nginx
```

---

## üìä **–ú–ï–¢–†–ò–ö–ò –ü–†–û–ï–ö–¢–ê:**

### **–í—Ä–µ–º—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
- **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: 2 —á–∞—Å–∞
- **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞**: 1 —á–∞—Å  
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: 30 –º–∏–Ω—É—Ç
- **Production**: 15 –º–∏–Ω—É—Ç
- **–ò–¢–û–ì–û**: 3.75 —á–∞—Å–∞

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Zero downtime –ø–µ—Ä–µ—Ö–æ–¥
- ‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å  
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:**

**API Gateway —É—Å–ø–µ—à–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ Beauty Platform!**

- üéØ **–ß–∞—Å—Ç–∏—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: Auth API —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Gateway
- üîß **Production ready**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ test-admin.beauty.designcorp.eu  
- üöÄ **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
- üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ enterprise –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é!**