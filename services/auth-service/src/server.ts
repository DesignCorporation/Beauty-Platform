// Beauty Platform Auth Service Server
// Express server with JWT authentication and authorization

import express from 'express'
import cors from 'cors'
import helmet from 'helmet'
import rateLimit from 'express-rate-limit'
import cookieParser from 'cookie-parser'
import csrf from 'csurf'
import pino from 'pino'
import pinoHttp from 'pino-http'
import dotenv from 'dotenv'
// Unused imports commented out
// import https from 'https'
// import fs from 'fs'
// import path from 'path'
// import authRoutes from './routes/auth'
import authSecureRoutes from './routes/auth-secure'
import clientAuthRoutes from './routes/client-auth'
import salonRegistrationRoutes from './routes/salon-registration'
import mfaRoutes from './routes/mfa'
import adminProtectedRoutes from './routes/admin-protected'

// Load environment variables
dotenv.config()

const app: express.Application = express()
const PORT = parseInt(process.env.PORT || '6021', 10)

// Trust proxy for nginx
app.set('trust proxy', 1)

// Logger configuration
const loggerOptions = {
  level: process.env.LOG_LEVEL || 'info',
  ...(process.env.NODE_ENV === 'development' && {
    transport: {
      target: 'pino-pretty',
      options: {
        colorize: true,
        translateTime: 'SYS:standard',
        ignore: 'pid,hostname'
      }
    }
  })
}
const logger = pino(loggerOptions)

// HTTP request logger
app.use(pinoHttp({ logger }))

// Security middleware
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}))

// CORS configuration
app.use(cors({
  origin: function (origin, callback) {
    // Allow requests from Beauty Platform domains
    const allowedOrigins = [
      'http://localhost:6001',           // Salon CRM (dev)
      'http://localhost:6002',           // Admin Panel (dev)
      'http://localhost:6003',           // Client Booking (dev)
      'http://localhost:6004',           // Public Websites (dev)
      'https://test-crm.beauty.designcorp.eu',     // Production CRM
      'https://test-admin.beauty.designcorp.eu',   // Production Test Admin
      'https://admin.beauty.designcorp.eu',        // Production Admin
      'https://client.beauty.designcorp.eu',       // Production Client Portal
      'https://book.beauty.designcorp.eu',         // Production Booking
      'https://beauty.designcorp.eu',              // Production Landing
      `http://135.181.156.117:6001`,              // Direct IP access
      `http://135.181.156.117:6002`,
      `http://135.181.156.117:6003`,
      `http://135.181.156.117:6004`
    ]

    // Allow requests with no origin (e.g. mobile apps, Postman)
    if (!origin) return callback(null, true)
    
    if (allowedOrigins.indexOf(origin) !== -1) {
      // Return the actual origin that made the request, not first from array
      callback(null, origin)
    } else {
      logger.warn(`CORS blocked request from origin: ${origin}`)
      callback(new Error('Not allowed by CORS'))
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'X-CSRF-Token']
}))

// Global rate limiting - –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –≤ development
const globalRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: parseInt(process.env.RATE_LIMIT_REQUESTS || '1000'), // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è development
  message: {
    success: false,
    error: 'Too many requests from this IP, please try again later',
    code: 'GLOBAL_RATE_LIMIT'
  },
  standardHeaders: true,
  legacyHeaders: false,
  skip: (req) => {
    // Skip rate limiting for health checks and in development mode
    if (process.env.NODE_ENV === 'development') {
      console.log('üîß Rate limiting DISABLED in development mode for:', req.path)
      return true
    }
    return req.path === '/health' || req.path === '/auth/health'
  }
})

app.use(globalRateLimit)

// Cookie parsing middleware (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è httpOnly cookies!)
app.use(cookieParser())

// CSRF Protection
const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production', // HTTPS —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
    sameSite: 'strict',
    maxAge: 60 * 60 * 1000 // 1 —á–∞—Å
  },
  // –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è endpoints, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç CSRF (GET –∑–∞–ø—Ä–æ—Å—ã –∏ –ø—É–±–ª–∏—á–Ω—ã–µ API)
  ignoreMethods: ['GET', 'HEAD', 'OPTIONS'],
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SPA - —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏–ª–∏ —Ç–µ–ª–µ
  value: function (req) {
    return req.headers['x-csrf-token'] || 
           (req.body && req.body._csrf) || 
           (req.query && req.query._csrf)
  }
})

// Body parsing middleware
app.use(express.json({ 
  limit: '10mb',
  verify: (_req, _res, buf) => {
    // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Å—Ç–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è refresh/logout endpoints)
    if (buf.length === 0) return
    
    try {
      JSON.parse(buf.toString())
    } catch (e) {
      logger.error('Invalid JSON in request body')
      throw new Error('Invalid JSON')
    }
  }
}))

app.use(express.urlencoded({ 
  extended: true, 
  limit: '10mb' 
}))

// Health check endpoint (–±–µ–∑ CSRF)
app.get('/health', (_req, res) => {
  res.json({
    success: true,
    service: 'auth-service',
    version: '1.0.0',
    port: PORT,
    environment: process.env.NODE_ENV || 'development',
    timestamp: new Date().toISOString(),
    uptime: Math.floor(process.uptime()),
    memory: {
      used: Math.round(process.memoryUsage().heapUsed / 1024 / 1024 * 100) / 100,
      total: Math.round(process.memoryUsage().heapTotal / 1024 / 1024 * 100) / 100
    }
  })
})

// CSRF token endpoint (–±–µ–∑ –∑–∞—â–∏—Ç—ã, —Ç.–∫. –≤—ã–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω)
app.get('/auth/csrf-token', csrfProtection, (req, res) => {
  res.json({
    success: true,
    csrfToken: req.csrfToken(),
    message: 'CSRF token generated successfully'
  })
})

// Middleware –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è CSRF –∑–∞—â–∏—Ç—ã
const conditionalCSRF = (req: express.Request, res: express.Response, next: express.NextFunction) => {
  // üö® –ö–†–ò–¢–ò–ß–ù–û: –ù–ï –£–î–ê–õ–Ø–¢–¨ –ù–ò–ö–ê–ö–ò–• –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô –ë–ï–ó –ü–û–õ–ù–û–ì–û –ü–û–ù–ò–ú–ê–ù–ò–Ø –ü–û–°–õ–ï–î–°–¢–í–ò–ô!
  // –í–ê–ñ–ù–û: req.path –ù–ï –≤–∫–ª—é—á–∞–µ—Ç –±–∞–∑–æ–≤—ã–π /auth prefix! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¢–û–õ–¨–ö–û –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏!
  const csrfExceptions = [
    'GET /health',          // req.path –¥–ª—è /auth/health
    'GET /me',              // req.path –¥–ª—è /auth/me  
    'GET /permissions',     // req.path –¥–ª—è /auth/permissions
    'GET /csrf-token',      // req.path –¥–ª—è /auth/csrf-token
    'GET /force-logout',    // req.path –¥–ª—è /auth/force-logout
    'POST /login',          // üö® –ö–†–ò–¢–ò–ß–ù–û: –ë–ï–ó –≠–¢–û–ì–û –ù–ò–ö–¢–û –ù–ï –ú–û–ñ–ï–¢ –í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£!
    'POST /refresh',        // –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è SPA - refresh –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ CSRF
    'POST /logout',         // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è logout –ø—Ä–æ–±–ª–µ–º—ã
    'GET /mfa/status',      // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è MFA
    'POST /mfa/setup/initiate', // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è MFA
    'POST /mfa/verify',     // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è MFA
    'POST /mfa/disable',    // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è MFA
    'POST /mfa/complete-login', // –í–†–ï–ú–ï–ù–ù–û: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è MFA
    'POST /mfa/test-db-update', // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    'POST /mfa/fix-admin-mfa',  // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MFA –¥–ª—è –∞–¥–º–∏–Ω–∞
    // Client auth endpoints (–Ω—É–∂–Ω—ã –¥–ª—è SPA –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞)
    'POST /register-client',  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    'POST /login-client',     // –í—Ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–æ–≤
    'POST /logout-client',    // –í—ã—Ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–æ–≤
    'GET /client/profile',    // –ü—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞
    // üö® –í–ù–ò–ú–ê–ù–ò–ï: Express req.path = –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –ë–ï–ó /auth –ø—Ä–µ—Ñ–∏–∫—Å–∞!
  ]
  
  const routeKey = `${req.method} ${req.path}`
  
  console.log(`üîê CSRF Check: ${routeKey} - Exception: ${csrfExceptions.includes(routeKey)}`)
  
  if (csrfExceptions.includes(routeKey)) {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º CSRF –¥–ª—è —ç—Ç–∏—Ö endpoints
    console.log(`‚úÖ CSRF Skipped for: ${routeKey}`)
    next()
  } else {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º CSRF –∑–∞—â–∏—Ç—É –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
    csrfProtection(req, res, next)
  }
}

// Debug middleware for all requests
app.use((req, res, next) => {
  console.log(`üîç Auth Service Request: ${req.method} ${req.path} - Headers:`, {
    host: req.headers.host,
    'x-forwarded-by': req.headers['x-forwarded-by'],
    'x-target-service': req.headers['x-target-service'],
    'authorization': req.headers.authorization ? 'present' : 'missing'
  });
  next();
});

// MFA routes (without CSRF protection for now - TEMPORARY) - MUST BE FIRST!
app.use('/auth/mfa', mfaRoutes)

// API routes - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–ª–æ–≤–Ω—É—é CSRF –∑–∞—â–∏—Ç—É –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö SPA endpoints
app.use('/auth', conditionalCSRF, authSecureRoutes)

// TEMPORARY: Add API routes for debugging proxy issues
app.use('/api/auth', conditionalCSRF, authSecureRoutes)

// Client authentication routes (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ endpoints –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞)
app.use('/auth', conditionalCSRF, clientAuthRoutes)

// Protected admin routes (requires MFA verification)
app.use('/auth/admin', conditionalCSRF, adminProtectedRoutes)
app.use('/api/auth/admin', conditionalCSRF, adminProtectedRoutes)

// Salon registration routes (without CSRF for easier integration)
app.use('/salon-registration', salonRegistrationRoutes)

// Root endpoint
app.get('/', (_req, res) => {
  res.json({
    success: true,
    message: 'Beauty Platform Auth Service',
    version: '1.0.0',
    docs: '/auth/health',
    endpoints: {
      auth: {
        csrfToken: 'GET /auth/csrf-token',
        login: 'POST /auth/login',
        register: 'POST /auth/register',
        refresh: 'POST /auth/refresh',
        logout: 'POST /auth/logout',
        me: 'GET /auth/me',
        permissions: 'GET /auth/permissions',
        changePassword: 'POST /auth/change-password'
      },
      client: {
        register: 'POST /auth/register-client',
        login: 'POST /auth/login-client',
        logout: 'POST /auth/logout-client',
        profile: 'GET /auth/client/profile',
        updateProfile: 'PUT /auth/client/profile'
      },
      mfa: {
        setup: 'POST /auth/mfa/setup',
        verify: 'POST /auth/mfa/verify',
        disable: 'POST /auth/mfa/disable',
        status: 'GET /auth/mfa/status'
      }
    }
  })
})

// 404 handler
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Endpoint not found',
    code: 'NOT_FOUND',
    path: req.originalUrl,
    method: req.method
  })
})

// Global error handler
app.use((error: any, req: express.Request, res: express.Response, _next: express.NextFunction) => {
  logger.error({
    error: error.message,
    stack: error.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    userAgent: req.get('User-Agent')
  }, 'Unhandled error')

  // Don't expose error details in production
  const isDevelopment = process.env.NODE_ENV === 'development'
  
  res.status(error.status || 500).json({
    success: false,
    error: isDevelopment ? error.message : 'Internal server error',
    code: error.code || 'INTERNAL_ERROR',
    ...(isDevelopment && { stack: error.stack })
  })
})

// Graceful shutdown
process.on('SIGTERM', () => {
  logger.info('SIGTERM received, shutting down gracefully')
  process.exit(0)
})

process.on('SIGINT', () => {
  logger.info('SIGINT received, shutting down gracefully')
  process.exit(0)
})

// Start server (HTTP for simplicity in development)
const server = app.listen(PORT, '0.0.0.0', () => {
  logger.info({
    port: PORT,
    protocol: 'HTTP',
    environment: process.env.NODE_ENV || 'development',
    cors: 'enabled',
    security: 'helmet + rate limiting',
    logging: 'pino'
  }, `üîê Beauty Platform Auth Service started`)
  
  logger.info(`üì° Health check: http://135.181.156.117:${PORT}/health`)
  logger.info(`üîë Auth endpoints: http://135.181.156.117:${PORT}/auth/*`)
})

// Handle server errors
server.on('error', (error: any) => {
  if (error.code === 'EADDRINUSE') {
    logger.error(`Port ${PORT} is already in use`)
    process.exit(1)
  } else {
    logger.error(error, 'Server error')
  }
})

export default app
