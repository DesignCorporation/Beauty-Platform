// Beauty Platform Database Schema
// Domain-Driven Design + Multi-tenant Architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// CORE ENTITIES - Business Domain
// ========================================

// User Roles - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π
enum UserRole {
  SUPER_ADMIN      // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
  SALON_OWNER      // –í–ª–∞–¥–µ–ª–µ—Ü —Å–∞–ª–æ–Ω–∞
  MANAGER          // –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–ª–æ–Ω–∞ (–º–µ–∂–¥—É Owner –∏ Staff)
  STAFF_MEMBER     // –ú–∞—Å—Ç–µ—Ä
  RECEPTIONIST     // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–µ—Å–µ–ø—à–µ–Ω–∞
  ACCOUNTANT       // –ë—É—Ö–≥–∞–ª—Ç–µ—Ä —Å–∞–ª–æ–Ω–∞
  CLIENT           // –ö–ª–∏–µ–Ω—Ç —Å–∞–ª–æ–Ω–∞
}

// Status –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
enum EntityStatus {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
  DELETED
}

// Language Support
enum Language {
  RU // –†—É—Å—Å–∫–∏–π
  EN // English
  PL // Polski
  UA // –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
}

// Currency Support - –≤–∫–ª—é—á–∞–µ–º RUB –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
enum Currency {
  USD // US Dollar
  EUR // Euro
  PLN // –ü–æ–ª—å—Å–∫–∏–π –∑–ª–æ—Ç—ã–π
  UAH // –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –≥—Ä–∏–≤–Ω–∞
  RUB // –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å (deprecated, –Ω–æ –Ω—É–∂–µ–Ω –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
}

// ========================================
// TENANTS - –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å
// ========================================

model Tenant {
  id          String   @id @default(cuid())
  slug        String   @unique // URL slug –¥–ª—è —Å–∞–ª–æ–Ω–∞
  name        String
  description String?
  
  // Contact Info
  email       String?
  phone       String?
  website     String?
  
  // Address
  country     String?
  city        String?
  address     String?
  postalCode  String?
  
  // Business Settings
  currency    Currency @default(PLN)  // –°—Ç–∞—Ä—Ç—É–µ–º —Å –ü–æ–ª—å—à–∏
  language    Language @default(RU)
  timezone    String   @default("Europe/Moscow")
  
  // Status
  status      EntityStatus @default(ACTIVE)
  isActive    Boolean      @default(true)
  
  // Relationships
  users       User[]
  clients     Client[]
  services    Service[]
  appointments Appointment[]
  invitations Invitation[]
  userSalonAccess UserSalonAccess[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("tenants")
}

// ========================================
// USERS - –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
// ========================================

model User {
  id        String   @id @default(cuid())
  
  // Tenant Isolation - –ö–†–ò–¢–ò–ß–ù–û!
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])
  
  // Auth Info
  email     String   @unique
  password  String   // bcrypt hash
  
  // Personal Info
  firstName String
  lastName  String
  phone     String?
  avatar    String?
  
  // Role & Permissions
  role      UserRole @default(CLIENT)
  
  // Staff Settings (for staff members)
  color     String?  // Personal color for calendar (hex)
  isActive  Boolean  @default(true)
  
  // Status
  status        EntityStatus @default(PENDING)
  emailVerified Boolean      @default(false)
  
  // Auth Tokens
  refreshTokens RefreshToken[]
  
  // MFA (Multi-Factor Authentication) - –¥–ª—è SUPER_ADMIN
  mfaEnabled    Boolean  @default(false)
  mfaSecret     String?  // TOTP secret (encrypted)
  mfaBackupCodes String? // JSON array of hashed backup codes
  
  // Relationships
  createdAppointments  Appointment[] @relation("AppointmentCreatedBy")
  assignedAppointments Appointment[] @relation("AppointmentAssignedTo")
  sentInvitations      Invitation[]  @relation("InviterInvitations")
  salonAccess          UserSalonAccess[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// JWT Refresh Tokens
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@map("refresh_tokens")
}

// ========================================
// CLIENTS - –ö–ª–∏–µ–Ω—Ç—ã —Å–∞–ª–æ–Ω–æ–≤
// ========================================

model Client {
  id       String @id @default(cuid())
  
  // Tenant Isolation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  
  // Personal Info
  name     String
  email    String?
  phone    String?
  
  // Additional Info
  notes    String?
  birthday DateTime?
  
  // Status
  status   EntityStatus @default(ACTIVE)
  
  // Relationships
  appointments Appointment[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([tenantId, email])
  @@unique([tenantId, phone])
  @@map("clients")
}

// ========================================
// SERVICES - –£—Å–ª—É–≥–∏ —Å–∞–ª–æ–Ω–∞
// ========================================

model Service {
  id          String @id @default(cuid())
  
  // Tenant Isolation
  tenantId    String
  tenant      Tenant @relation(fields: [tenantId], references: [id])
  
  // Service Info
  name        String
  description String?
  duration    Int    // –í –º–∏–Ω—É—Ç–∞—Ö
  price       Decimal @db.Decimal(10, 2)
  
  // Status
  status      EntityStatus @default(ACTIVE)
  
  // Relationships
  appointments Appointment[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("services")
}

// ========================================
// APPOINTMENTS - –ó–∞–ø–∏—Å–∏
// ========================================

enum AppointmentStatus {
  PENDING    // –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  CONFIRMED  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
  IN_PROGRESS // –í –ø—Ä–æ—Ü–µ—Å—Å–µ
  COMPLETED  // –ó–∞–≤–µ—Ä—à–µ–Ω–∞
  CANCELLED  // –û—Ç–º–µ–Ω–µ–Ω–∞
  NO_SHOW    // –ù–µ –ø—Ä–∏—à–µ–ª
}

model Appointment {
  id              String            @id @default(cuid())
  appointmentNumber String          // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏
  
  // Tenant Isolation
  tenantId        String
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  
  // Appointment Info
  date            DateTime          // –î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏
  startTime       DateTime          // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
  endTime         DateTime          // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
  
  // Relationships
  clientId        String
  client          Client            @relation(fields: [clientId], references: [id])
  
  serviceId       String
  service         Service           @relation(fields: [serviceId], references: [id])
  
  assignedToId    String?
  assignedTo      User?             @relation("AppointmentAssignedTo", fields: [assignedToId], references: [id])
  
  // Status & Notes
  status          AppointmentStatus @default(PENDING)
  notes           String?
  
  // Audit Trail
  createdById     String?
  createdBy       User?             @relation("AppointmentCreatedBy", fields: [createdById], references: [id])
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@unique([tenantId, appointmentNumber])
  @@map("appointments")
}

// ========================================
// STAFF INVITATION SYSTEM
// ========================================

// –°—Ç–∞—Ç—É—Å—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
enum InviteStatus {
  PENDING   // –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞
  ACCEPTED  // –ü—Ä–∏–Ω—è—Ç–æ –º–∞—Å—Ç–µ—Ä–æ–º
  DECLINED  // –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–º
  EXPIRED   // –ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
  REVOKED   // –û—Ç–æ–∑–≤–∞–Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–∞–ª–æ–Ω–∞
}

// –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤
model Invitation {
  id              String   @id @default(cuid())
  
  // –°–∞–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  inviterUserId   String   // –ö—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
  inviter         User     @relation("InviterInvitations", fields: [inviterUserId], references: [id])
  
  // –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–∞–µ–º–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞
  masterEmail     String
  masterPhone     String?
  masterName      String
  personalMessage String?  // –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞
  role            UserRole @default(STAFF_MEMBER)
  permissions     String[] @default(["calendar.view", "appointments.manage"])
  
  // –°—Ç–∞—Ç—É—Å –∏ —Ç–æ–∫–µ–Ω—ã
  status          InviteStatus @default(PENDING)
  token           String   @unique @default(cuid())
  expiresAt       DateTime // –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (7 –¥–Ω–µ–π)
  
  // –°–≤—è–∑—å —Å —Å–æ–∑–¥–∞–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º
  userSalonAccess UserSalonAccess[]
  
  // Timestamps
  createdAt       DateTime @default(now())
  sentAt          DateTime?
  acceptedAt      DateTime?
  declinedAt      DateTime?
  
  @@map("invitations")
}

// –°–≤—è–∑—å –º–∞—Å—Ç–µ—Ä-—Å–∞–ª–æ–Ω (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
model UserSalonAccess {
  id            String   @id @default(cuid())
  
  // –°–≤—è–∑–∏
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  
  // –ü—Ä–∞–≤–∞ –∏ —Ä–æ–ª–∏
  role          UserRole
  permissions   String[] // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
  isOwner       Boolean  @default(false)  // –í–ª–∞–¥–µ–ª–µ—Ü —Å–∞–ª–æ–Ω–∞
  isActive      Boolean  @default(true)   // –ê–∫—Ç–∏–≤–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
  
  // –°–≤—è–∑—å —Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º
  invitationId  String?  // –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
  invitation    Invitation? @relation(fields: [invitationId], references: [id])
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—Ç—ã
  priority      Int      @default(1)      // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–∞–ª–æ–Ω–∞ (1 = –æ—Å–Ω–æ–≤–Ω–æ–π)
  canSeeFinances Boolean @default(false)  // –î–æ—Å—Ç—É–ø –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º
  workingHours  Json?    // –†–∞–±–æ—á–∏–µ —á–∞—Å—ã –≤ –¥–∞–Ω–Ω–æ–º —Å–∞–ª–æ–Ω–µ
  
  // Timestamps
  createdAt     DateTime @default(now())
  lastActiveAt  DateTime @default(now())
  
  @@unique([userId, tenantId])
  @@map("user_salon_access")
}

// ========================================
// AUDIT & LOGGING
// ========================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id          String      @id @default(cuid())
  
  // Tenant Context
  tenantId    String?
  
  // Action Info
  action      AuditAction
  entityType  String      // "User", "Appointment", etc.
  entityId    String?     // ID —Å—É—â–Ω–æ—Å—Ç–∏
  
  // User Context
  userId      String?
  userRole    UserRole?
  
  // Changes
  oldValues   Json?       // –°—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  newValues   Json?       // –ù–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  
  // Technical Info
  ipAddress   String?
  userAgent   String?
  
  // Timestamp
  createdAt   DateTime    @default(now())
  
  @@map("audit_logs")
}

// ========================================
// PAYMENT SERVICE - Stage 5 Models
// ========================================

// üí∞ –ü–ª–∞—Ç–µ–∂–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
model Payment {
  id                     String       @id @default(cuid())
  tenantId               String       @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation

  // Provider data (generic)
  provider               String       // stripe, paypal, etc.
  providerId             String?      // Provider's payment ID

  // Customer reference
  customerId             String?      @map("customer_id") // –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç snake_case

  // –°—É–º–º–∞ –∏ –≤–∞–ª—é—Ç–∞ (integer in cents/units)
  amount                 Int          // Amount in cents/units
  currency               String       @default("EUR") // EUR, PLN, USD

  // –°—Ç–∞—Ç—É—Å
  status                 String       // PENDING, SUCCEEDED, FAILED, CANCELLED

  // Metadata
  metadata               Json?        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Provider
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  // Relations
  refunds                Refund[]      // Payment can have multiple refunds
  events                 PaymentEvent[] // Payment can have multiple events
  invoiceEmails          InvoiceEmail[] // Payment can have multiple invoice emails

  @@index([tenantId])
  @@index([status])
  @@map("payments")
}

// üßæ –ò–Ω–≤–æ–π—Å—ã –¥–ª—è PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
model Invoice {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  subscriptionId    String?
  paymentId         String?

  // –ù–æ–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞
  invoiceNumber     String    @unique

  // –°—É–º–º—ã
  subtotal          Decimal   @db.Decimal(10,2)
  taxAmount         Decimal   @db.Decimal(10,2) @default(0)
  totalAmount       Decimal   @db.Decimal(10,2)
  currency          String    @default("EUR")

  // –ü–µ—Ä–∏–æ–¥—ã
  periodStart       DateTime
  periodEnd         DateTime
  dueDate           DateTime

  // –°—Ç–∞—Ç—É—Å
  status            String    // DRAFT, SENT, PAID, OVERDUE, CANCELLED

  // PDF
  pdfUrl            String?   // URL –∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É PDF

  // Metadata
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

// üîÑ –í–æ–∑–≤—Ä–∞—Ç—ã —Å—Ä–µ–¥—Å—Ç–≤ (Stage 5)
model Refund {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  paymentId         String    @map("payment_id") // Reference to Payment

  // Provider refund data
  provider          String    // "stripe" | "paypal"
  providerRefundId  String?   @map("provider_refund_id") // Provider's refund ID

  // Amount and currency
  amount            Int       // Amount in cents/units
  currency          String    @default("EUR")

  // Status tracking
  status            String    @default("pending") // pending, succeeded, failed
  reason            String?   // Optional refund reason

  // Metadata
  metadata          Json?     // Additional provider data
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  payment           Payment?  @relation(fields: [paymentId], references: [id])
  events            PaymentEvent[] // For webhook deduplication

  @@index([tenantId])
  @@index([paymentId])
  @@index([providerRefundId])
  @@index([status])
  @@map("refunds")
}

// üìß Email delivery tracking (Stage 5)
model InvoiceEmail {
  id               String    @id @default(uuid())
  tenantId         String    @map("tenant_id") // üîê –ö–†–ò–¢–ò–ß–ù–û: Tenant isolation
  paymentId        String    @map("payment_id") // Reference to Payment

  // Email data
  to               String    // Recipient email address
  subject          String?   // Email subject
  status           String    @default("queued") // queued | sent | failed

  // Provider response
  providerResponse Json?     @map("provider_response") // Provider response data

  // Timestamps
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  payment          Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([paymentId])
  @@index([status])
  @@map("invoice_emails")
}

// üìù Payment events for webhook deduplication (Stage 5)
model PaymentEvent {
  id            String    @id @default(cuid())
  tenantId      String?   @map("tenant_id") // Optional: events can be global

  // Provider event data
  provider      String    // "stripe" | "paypal"
  eventType     String    @map("event_type") // Provider event type
  eventId       String    @unique @map("event_id") // Provider event ID (for deduplication)

  // Related entities
  paymentId     String?   @map("payment_id") // Optional payment reference
  refundId      String?   @map("refund_id") // Optional refund reference

  // Event payload
  payload       Json      // Full webhook payload
  processed     Boolean   @default(false)

  // Metadata
  receivedAt    DateTime  @default(now()) @map("received_at")

  // Relations
  payment       Payment?  @relation(fields: [paymentId], references: [id])
  refund        Refund?   @relation(fields: [refundId], references: [id])

  @@index([eventId]) // For fast deduplication lookup
  @@index([provider, eventType])
  @@index([paymentId])
  @@index([refundId])
  @@map("payment_events")
}

// üîë Idempotency keys for API requests (24h TTL)
model IdempotencyKey {
  key          String    @id // Client-provided idempotency key (primary key in DB)
  tenantId     String    @map("tenant_id") // Tenant isolation
  requestHash  String    @map("request_hash") // SHA256 of request data
  response     Json      // Cached response
  expiresAt    DateTime  @map("expires_at") // Auto-cleanup after 24h
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([tenantId])       // Tenant filtering
  @@index([expiresAt])      // For cleanup queries
  @@map("idempotency_keys")
}