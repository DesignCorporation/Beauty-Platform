name: ğŸš€ Beauty Platform CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  PRODUCTION_SERVER: '135.181.156.117'

jobs:
  # ğŸ§ª CI: Continuous Integration
  test:
    name: ğŸ§ª Test & Build
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8

    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” TypeScript check
      run: pnpm run typecheck

    - name: ğŸ§¹ Lint check
      run: pnpm run lint

    - name: ğŸ§ª Run tests
      run: pnpm run test

    - name: ğŸ“¦ Build project
      run: pnpm run build

    - name: ğŸ“Š Build status
      run: |
        echo "âœ… CI ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
        echo "ğŸ“¦ ĞŸÑ€Ğ¾ĞµĞºÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ´ĞµĞ¿Ğ»Ğ¾Ñ"

  # ğŸš€ CD: Continuous Deployment (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ main Ğ²ĞµÑ‚ĞºĞ¸)
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸš€ Trigger production deployment
      run: |
        echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ deployment Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€Ğµ..."

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ webhook Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Event: push" \
          -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
          -d '{
            "repository": {
              "name": "${{ github.repository }}",
              "full_name": "${{ github.repository }}"
            },
            "ref": "${{ github.ref }}",
            "head_commit": {
              "id": "${{ github.sha }}",
              "message": "${{ github.event.head_commit.message }}",
              "author": {
                "name": "${{ github.event.head_commit.author.name }}",
                "email": "${{ github.event.head_commit.author.email }}"
              }
            },
            "pusher": {
              "name": "${{ github.actor }}"
            }
          }' \
          "https://${{ env.PRODUCTION_SERVER }}:3333/webhook/deploy" || \
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Event: push" \
          -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
          -d '{
            "repository": {
              "name": "${{ github.repository }}",
              "full_name": "${{ github.repository }}"
            },
            "ref": "${{ github.ref }}",
            "head_commit": {
              "id": "${{ github.sha }}",
              "message": "${{ github.event.head_commit.message }}",
              "author": {
                "name": "${{ github.event.head_commit.author.name }}",
                "email": "${{ github.event.head_commit.author.email }}"
              }
            },
            "pusher": {
              "name": "${{ github.actor }}"
            }
          }' \
          "http://${{ env.PRODUCTION_SERVER }}:3333/webhook/deploy"

        echo "âœ… Deployment webhook Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ½Ğ° production ÑĞµÑ€Ğ²ĞµÑ€"
        echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ: ./beauty-dev.sh logs webhook"

  # ğŸ“Š Status notification
  notify:
    name: ğŸ“Š Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()

    steps:
    - name: ğŸ“Š Report status
      run: |
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "âœ… CI/CD Pipeline ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
          echo "ğŸŒ Production URLs:"
          echo "   Landing: https://beauty.designcorp.eu"
          echo "   CRM: https://salon.beauty.designcorp.eu"
          echo "   Admin: https://admin.beauty.designcorp.eu"
          echo "   Client: https://client.beauty.designcorp.eu"
        elif [[ "${{ needs.test.result }}" == "failure" ]]; then
          echo "âŒ CI Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸Ğ»Ğ¸ÑÑŒ! Deployment Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½."
          exit 1
        elif [[ "${{ needs.deploy.result }}" == "failure" ]]; then
          echo "âš ï¸ CI Ğ¿Ñ€Ğ¾ÑˆĞµĞ», Ğ½Ğ¾ deployment Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑ!"
          echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ webhook endpoint Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ"
          exit 1
        else
          echo "âš ï¸ ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ pipeline"
          exit 1
        fi